(window.webpackJsonp=window.webpackJsonp||[]).push([[24],{"3Bw1":function(e,t){e.exports='<bb-modal id="content-deleted-modal"\n          class="notification"\n          modal-title-key="base.stream.modal.deleted.title"\n          analytics-id-tag-prefix="base.stream.modal.deleted">\n  <div name="modal-contents">\n    <p bb-translate>base.stream.modal.deleted.body</p>\n  </div>\n  <button name="modal-footer-button-primary" class="button confirm-ok js-primary-button" ng-click="$parent.$close()" bb-translate analytics-id="global.ok">global.ok</button>\n</bb-modal>\n'},"7C3+":function(e,t,s){"use strict";s.d(t,"g",(function(){return f})),s.d(t,"h",(function(){return S})),s.d(t,"f",(function(){return _})),s.d(t,"e",(function(){return g})),s.d(t,"a",(function(){return I})),s.d(t,"d",(function(){return D})),s.d(t,"b",(function(){return v})),s.d(t,"c",(function(){return C}));var r=s("nsO7"),n=s("Llzl"),a=s("6ynb"),i=s("0JpG"),o=s("vhkR"),c=s("Is+C"),l=s("Fvsw"),d=s("KBr+"),u=s("P2dS"),h=s("12mu"),p=s("pjml"),m=s("8jzW"),y=s("KtUo"),E=s("r6lH"),b=s("av75"),T=s("nmzr");const f="ultra.service.stream.transformer.data",S="baseStreamEntryTransformer";class _{static getCourseId(e){return e&&e.se_courseId||e&&e.se_orgId||""}static getCourseName(e){return e&&e.ui.streamCourse&&e.ui.streamCourse.name||""}static getSequenceId(e){return e.se_id.substr(e.providerId.length)}static getEntryType(e){if(e){const t=e.extraAttribs&&e.extraAttribs.event_type||e.providerId;if(t&&t.length>0)return t.trim()}throw new Error("Type identifier does not exist on the given Learn stream entry."+(e.se_id||""))}static generateStreamId(e){return e&&e.se_id||"local_"+_.index++}static validateEntriesForGrouping(e,t){let s=e&&e.length>0;if(s){const r=e[0].courseId;s=e.every(e=>e.isGroupable&&t.some(t=>t===e.type)&&e.courseId===r)}return s}static hasNewEntry(e){return e&&e.some(e=>e.isNew)||!1}static getMostRecentEntry(e){return e&&e.length>0?r.sortBy(e,"notificationCreationDate")[e.length-1]:null}static getGroupedEntryIds(e){let t=[];return e&&Array.isArray(e)&&e.forEach(e=>{const s=e.groupedEntryIds;s?t=t.concat(s):t.push(e.id)}),t}static getDistinctAuthorIds(e,t){const s={};return e.forEach(e=>{const r=e.authorIds;if(r)r.forEach(e=>{s[e]=s[e]||[]});else{const r=t(e);(s[r]=s[r]||[]).push(e)}}),Object.keys(s)}static getCoursePanelStateRef(e,t){return"course.outline("+n.toJson({courseId:e,legacyUrl:t})+")"}static getDiscussionPanelStateRef(e,t){return'discussion.view.with-grading({ contentId: "'+e+'", courseId: "'+t+'" })'}static getJournalPanelStateRef(e,t){return`${T.JournalRoutes.JOURNAL_VIEW_WITH_PARTICIPATION}({ contentId: "${e}", courseId: "${t}" })`}}_.DUE_DATE_FORMAT=i.ILocaleDatetimeFormat.Short,_.index=1;class g extends a.a{constructor(e){super(e),this.name="StreamEntriesGroupingError"}}class I{constructor(e){this.supportedTypes=e}canHandle(e){return e&&this.canHandleType(_.getEntryType(e))}canHandleType(e){return this.supportedTypes&&this.supportedTypes.some(t=>0===t.indexOf(e))}convert(e){return{id:_.generateStreamId(e),type:_.getEntryType(e),providerId:e.providerId,eventType:e.itemSpecificData.eventType,notificationCreationDate:e.se_timestamp>0?new Date(e.se_timestamp):null,contextualDate:null,icon:null,isNew:!1,isImportant:!1,isGroupable:!1,courseId:_.getCourseId(e),isOrg:e&&e.ui.streamCourse&&e.ui.streamCourse.isOrganization||null,header:_.getCourseName(e),title:null,contentHandler:e.itemSpecificData.contentDetails&&e.itemSpecificData.contentDetails.contentHandler}}setLegacyCourseUrlRefToBody(e,t){const s=e&&e.ui&&e.ui.streamCourse,r=e&&e.se_itemUri;s&&s.isClassic()&&r&&(t.body=t.body||{},t.body.stateRef=_.getCoursePanelStateRef(s.id,r))}}class D extends I{constructor(e,t){super(t),this.bbLocalize=e}convert(e){const t=super.convert(e);return t.entrySpecificData=e.ui.streamUser?{streamUser:e.ui.streamUser}:null,t}getUserDisplayName(e){return this.bbLocalize.formatUsername(e,i.ILocaleUsernameFormat.Short,null,{noWrap:!0,noEscape:!0})}}class v extends I{constructor(){super([])}canHandle(e){return!1}canHandleType(e){return!1}convert(e){const t=super.convert(e),s=e.itemSpecificData;return t.icon=v.DEFAULT_ICON,t.body={type:b.a.SimpleText,content:{bodyText:s.contentExtract||e.se_details||e.se_context}},t}}v.DEFAULT_ICON="post";class C extends I{constructor(e,t){super(y.b(e)),this.supportedEventTypes=e}canHandleType(e){if(!this.supportedEventTypes||!Object.keys(this.supportedEventTypes).length)return!1;const t=e.split(":")[0],s=this.supportedEventTypes[t];return s&&s.length>0&&s.some(t=>0===t.indexOf(e))}convert(e){const t=super.convert(e),s=e.itemSpecificData.notificationDetails;return t.icon=C.TYPE_ICON_MAPPINGS[s.sourceType]||t.icon,t.notificationIds=s.notificationIds,t}}C.TYPE_ICON_MAPPINGS={AS:"assignment",BL:"blog",CM:"message",CR:"course",DF:"discussion",DT:"discussion",JN:"journal",GB:"grades",PE:"test",PS:"test",QU:"course",SU:"survey",SC:"scormengine",TE:"test",UA:"assignment",WK:"wiki"};class P extends v{}n.module(f,[i.moduleName,o.a,c.b,l.a,d.a,h.a,p.N,m.b,E.a,u.b]).service(S,v)},"8iPc":function(e,t){e.exports='<p class="summary" ng-if="::bodyContent().bodyText" ng-bind-html="::bodyContent().bodyText"></p>\n<a class="button button--secondary action-button"\n   ng-if="::!bodyContent().isComponentActionSref"\n   bb-peek-sref="{{bodyContent().actionSref}}"\n   analytics-id="base.stream.entryBody.telemetry.link">{{::bodyContent().actionText}}</a>'},"KBr+":function(e,t,s){"use strict";var r=s("Llzl"),n=s("iYZE");class a{constructor(e,t,s,r){this.modelStatic=t,this.$q=s,this.$timeout=r,this.toFetch={},this.cache=new n(e)}push(e,t){const s=this.cache.get(e);if(void 0!==s)return t(null,this.modelStatic.$buildRaw(s),e);const r=this.toFetch[e];null==r?this.toFetch[e]=[t]:r.push(t)}load(e){const t=this.$q.defer();return r.isArray(e)&&e.length>0||!r.isArray(e)?this._loadInternal(e,(e,s,r)=>{e?t.reject(e):t.resolve(s)}):t.resolve({}),t.promise}_loadInternal(e,t){if(Array.isArray(e)){const s=this.getCoalescingCallback(e.length,t);for(let t=0;t<e.length;t++)this.push(e[t],s)}else this.push(e,t);this.lazyLoad()}_load(){const e=this.toFetch;this.toFetch={};const t=Object.keys(e);0!==t.length&&this.modelStatic.findMany(t).$asPromise().then(s=>{let r,n={};if(Array.isArray(s))for(let e=0;e<s.length;e++)n[(r=s[e]).id]=r;else{if("object"!=typeof s)throw new Error("Invalid items format");n=s}for(let s=0;s<t.length;s++){const a=t[s];r=n[a];const i=e[a];this.cache.set(a,void 0===r?null:r.$encode());for(let e=0;e<i.length;e++)i[e](null,r,a)}},s=>{t.forEach(t=>{e[t].forEach(e=>{e(s)})})})}lazyLoad(){null==this.timeout&&(this.timeout=this.$timeout(()=>{this._load(),this.timeout=null},0,!1))}getCoalescingCallback(e,t){let s=!1;const r={};let n=0;return(a,i,o)=>{if(!s){if(a)return s=!0,t(a);i&&(r[o]=i),++n>=e&&(s=!0,t(null,r))}}}}r.module("ultra.utility.batchLoader",[]).factory("BatchLoaderFactory",["$q","$timeout",(e,t)=>(function(s,r){return new a(s,r,e,t)})]);var i=s("pjml");s.d(t,"a",(function(){return o})),s.d(t,"b",(function(){return c}));const o="ultra.batchLoader.courseNameBatchLoader",c="CourseBatchLoader";class l{constructor(e,t){this.batchLoader=e(200,t)}load(e){return this.batchLoader.load(e)}}l.$inject=["BatchLoaderFactory",i.m.serviceName];class d extends l{}r.module(o,["ultra.utility.batchLoader",i.N]).service(c,l)},KtUo:function(e,t,s){"use strict";s.d(t,"c",(function(){return r})),s.d(t,"a",(function(){return n})),s.d(t,"b",(function(){return a}));const r=function(e){return e.contextualDate||e.notificationCreationDate},n=function(e,t){const s=new Date(t.getTime());s.setHours(0,0,0,0);const r=new Date(s.getTime()+864e5);return e<s?-1:e>=r?1:0},a=function(e){return e&&Object.keys(e||{}).reduce((t,s)=>t.concat(e[s]),[])}},OaxLs:function(e,t,s){"use strict";var r=s("D57K"),n=s("nsO7"),a=s("Llzl"),i=s("5MwF"),o=s("Fvsw"),c=s("xpqL"),l=s("yC9S"),d=s("adx1"),u=s("aHpC"),h=s("MOka"),p=s("KtUo");var m=function(e){return e.filter((function(e){return e.isImportant}))};var y=function(e,t){return e.filter((function(e){const s=p.c(e);return!e.isImportant&&s&&p.a(s,t)<0}))};var E=function(e,t){return e.filter((function(e){const s=p.c(e);return!e.isImportant&&s&&0===p.a(s,t)}))};var b=function(e,t){return e.filter((function(e){const s=p.c(e);return!e.isImportant&&s&&p.a(s,t)>0}))},T=s("av75");class f{constructor(){this.allEntries=[],this.view=[]}addEntries(e){this.allEntries=this.allEntries.concat(e)}refreshView(e){this.view=[].concat((e?e(this.allEntries):this.allEntries).filter(e=>!e.hidden))}deleteEntries(e){this.allEntries=this.allEntries.filter(t=>-1===e.indexOf(t.id))}}class S extends f{constructor(e){super(),this.entryLoader=e}addEntries(e){super.addEntries(m(e))}deleteEntry(e){if(e.isImportant){const t=this.allEntries.indexOf(e);t>=0&&(this.allEntries.splice(t,1),this.refreshView(this.entryLoader.viewFilter))}}refreshView(e){super.refreshView(e),this.entryLoader._updateBadgeCount()}}class _ extends f{constructor(e){super(),this.context=e,this.hasMoreInView=!1}addEntries(e){super.addEntries(b(e,this.context.getServerTime())),this.allEntries=n.sortBy(this.allEntries,p.c)}refreshView(e){super.refreshView(e);const t=this.view.slice(A.UPCOMING_MAX_LENGTH,this.view.length);this.hasMoreInView=t.length>0&&t.some(e=>e.body&&e.body.type===T.a.DueDatedContent),this.view=this.hasMoreInView?this.view.slice(0,A.UPCOMING_MAX_LENGTH):this.view}}class g extends f{constructor(e,t,s){super(),this.context=e,this.entryLoader=t,this.streamSettings=s}addEntries(e){super.addEntries(E(e,this.context.getServerTime())),this.allEntries=this.entryLoader.groupStreamEntries(this.allEntries);const t=this.context.getServerTime(),s=this.allEntries.filter(e=>p.c(e)>=t),r=this.allEntries.filter(e=>p.c(e)<t);this.allEntries=n.sortBy(s,p.c).concat(n.sortBy(r,p.c).reverse()),this.allEntries.forEach(e=>{e.hidden=this.streamSettings.hidden(e)})}deleteEntries(e){this.allEntries=this.allEntries.filter(t=>{const s=t;if(s.groupedEntryIds){s.groupedEntryIds=s.groupedEntryIds.filter(t=>-1===e.indexOf(t));const t=s;return t.entryContents&&(t.entryContents=t.entryContents.filter(t=>-1===e.indexOf(t.id))),s.groupedEntryIds.length>0}return-1===e.indexOf(t.id)})}}class I extends f{constructor(e,t){super(),this.context=e,this.entryLoader=t,this._currentViewFilter=null,this.queuedView=[]}addEntries(e){super.addEntries(y(e,this.context.getServerTime())),this.allEntries=n.sortBy(this.allEntries,p.c).reverse()}refreshView(e){this.queuedView=[].concat((e?e(this.allEntries):this.allEntries).filter(e=>!e.hidden)),(e||null)!==this._currentViewFilter?(this.view=[],this.loadMoreEntriesIntoView(),this._currentViewFilter=e):this.view=this.queuedView.splice(0,this.view.length)}loadMoreEntriesIntoView(){if(this.queuedView.length>0){const e=this.queuedView.splice(0,this._numEntriesToLoad());Array.prototype.push.apply(this.view,e)}}_numEntriesToLoad(){const e=this.entryLoader.countViewEntries();return e>=I.MAX_ENTRIES_TO_PROGRESSIVE_LOAD?I.MAX_ENTRIES_TO_PROGRESSIVE_LOAD:I.MAX_ENTRIES_TO_PROGRESSIVE_LOAD-e}get MAX_ENTRIES_TO_PROGRESSIVE_LOAD(){return I.MAX_ENTRIES_TO_PROGRESSIVE_LOAD}}I.MAX_ENTRIES_TO_PROGRESSIVE_LOAD=20;var D=s("eQBN");s.d(t,"c",(function(){return v})),s.d(t,"d",(function(){return C})),s.d(t,"a",(function(){return R})),s.d(t,"b",(function(){return A}));const v="ultra.service.stream.loader",C="streamEntryLoader";let P=0;const R="PullingTaskScheduled";let A=class e extends d.a{constructor(e,t,s,r,a,i,o,c){super(),this.$interval=e,this.$log=t,this.$q=s,this.$rootScope=r,this.context=a,this.streamEntryManager=i,this.streamSettings=o,this.studentPreview=c,this.badgeCount=0,this.loadingErrorCount=0,this.buckets={},this.preLoading=!0,this.loadingStreamEntriesInProgress=!1,this.oneLoadingIsQueued=!1,this.buckets={important:new S(this),upcoming:new _(a),today:new g(a,this,o),previous:new I(a,this)},l.b.OnRootScope(this.$rootScope,"stream-entry-parent-item-not-found",(e,t)=>{this.deleteEntries([t.id]),this.refreshEntries(!0)}),l.b.OnRootScope(this.$rootScope,"stream-settings-updated",()=>{this.reapplySettings()}),this.studentPreview.isInIframeOfPreviewMode()||this.init(),l.b.OnRootScope(this.$rootScope,"update-course-status",(e,t)=>{const s=[];n.forEach(this.buckets,e=>{n.forEach(e.allEntries,e=>{e.courseId&&e.courseId===t&&!e.isOrg&&s.push(e.id)})}),this.deleteEntries(s),this.refreshEntries(!0)}),l.b.OnRootScope(this.$rootScope,"update-course-name",(e,t)=>{n.forEach(this.buckets,e=>{n.forEach(e.allEntries,e=>{e.courseId&&e.courseId===t.id&&!e.isOrg&&(e.header=t.displayName)})})})}init(){this.initialLoading=this.streamSettings.initializeSettings().finally(()=>{this.preLoading=!1;try{return this.schedulePullingTask()}finally{this.currentTask.run()}}),this.streamEntryManager.$onStreamPulled((e,t)=>{this._queueStreamData(t)})}schedulePullingTask(e=!1){if(this.currentTask&&!e)return this.currentTask.promise;this.$log.debug("Stream Polling Task Scheduled",(new Date).toISOString());const t=this.$q.defer(),s=this.$q.defer(),r=this.currentTask={id:P++,run:n.once(()=>{window.requestAnimationFrame(()=>{this.$log.debug("Stream Polling Task Running",(new Date).toISOString()),this._loadEntries(e).finally(()=>{t.resolve(!0),r.run=n.once(()=>s.resolve());const e=this.$interval(n.noop,i.a.streamLoadingInterval,1,!1);return this.$q.race([s.promise,e]).then(()=>{this.$interval.cancel(e)})}).then(()=>{this.currentTask=null,this.schedulePullingTask()})})}),promise:t.promise};return this.$emitEvent(R,this.currentTask),t.promise}_loadEntries(e){return this.loadingStreamEntriesInProgress?this.oneLoadingIsQueued?null:(this.oneLoadingIsQueued=!0,this.loadEntriesPromise.then(()=>(this.oneLoadingIsQueued=!1,this._loadEntries(e)))):(this.loadingStreamEntriesInProgress=!0,this.loadEntriesPromise=this.streamEntryManager.loadAllStreamEntries(()=>{},e).then(()=>{this.loadingErrorCount=0},()=>{this.loadingErrorCount++,this.loadingErrorCount>=O.MAX_LOADING_ERRORS&&this.cancelPeriodicLoading()}).finally(()=>{this.loadingStreamEntriesInProgress=!1}),this.loadEntriesPromise)}refreshEntries(e){return this.schedulePullingTask(e)}cancelPeriodicLoading(){this.$log.error("Stream loading errors")}reapplySettings(){this.getAllEntries().then(e=>{e.forEach(e=>{e.hidden=this.streamSettings.hidden(e)}),this._refreshViews()})}isStreamLoading(){return this.loadingStreamEntriesInProgress||this.preLoading}groupStreamEntries(t){if(t&&t.length>0){const s={};t.forEach(t=>{const r=t.type+e.ENTRY_GROUPING_KEY_DELIMITER+t.courseId;(s[r]=s[r]||[]).push(t)});let r=[];return Object.keys(s).forEach(t=>{let n=s[t];if(1!==n.length&&n[0].isGroupable){const s=t.split(e.ENTRY_GROUPING_KEY_DELIMITER)[0];n=this.streamEntryManager.processGroupStreamEntry(n,s),r=r.concat(n)}else r=r.concat(n)}),r}return t}bulkUpdateEntryStatus(e){e.forEach(e=>{a.isUndefined(e.hidden)&&(e.hidden=this.streamSettings.hidden(e))})}_queueStreamData(e){this._deleteEntries(e.deletedIds,!1),this._populateEntries(e.entries)}_populateEntries(e){this.bulkUpdateEntryStatus(e),this.addEntries(e,!1)}deleteEntries(e){this._deleteEntries(e,!1)}_deleteEntries(e,t){e&&e.length>0&&(this.allBuckets().forEach(t=>t.deleteEntries(e)),t||this._refreshViews())}addEntries(e,t){e&&e.length>0&&(this.allBuckets().forEach(t=>t.addEntries(e)),t||this._refreshViews())}removeImportantEntry(e){this.buckets.important.deleteEntry(e)}_refreshViews(){this.allBuckets().forEach(e=>e.refreshView(this.viewFilter))}_updateBadgeCount(){this.badgeCount=this.buckets.important.view.length}allBuckets(){return Object.keys(this.buckets).reduce((e,t)=>(e.push(this.buckets[t]),e),[])}_countAllEntries(){return this.allBuckets().reduce((e,t)=>e+t.allEntries.length,0)}findEntry(e){return this.getAllEntries().then(t=>n.find(t,{id:e}))}getAllEntries(){return this.studentPreview.isInIframeOfPreviewMode()?this.$q.when([]):this.initialLoading.then(()=>this._getAllEntries())}_getAllEntries(){return Object.keys(this.buckets).reduce((e,t)=>e.concat(this.buckets[t].allEntries),[])}countViewEntries(){return this.allBuckets().reduce((e,t)=>e+t.view.length,0)}setViewFilter(e){this.viewFilter=e,this._refreshViews()}_reset(){this.allBuckets().forEach(e=>{e.allEntries=[]}),this._refreshViews()}};A.ENTRY_GROUPING_KEY_DELIMITER="##",A.UPCOMING_MAX_LENGTH=5,A.MAX_LOADING_ERRORS=3,A=Object(r.__decorate)([Object(r.__param)(0,Object(u.b)("$interval")),Object(r.__param)(1,Object(u.b)("$log")),Object(r.__param)(2,Object(u.b)("$q")),Object(r.__param)(3,Object(u.b)("$rootScope")),Object(r.__param)(4,Object(u.b)(o.b)),Object(r.__param)(5,Object(u.b)(c.b)),Object(r.__param)(6,Object(u.b)(h.b)),Object(r.__param)(7,Object(u.b)(D.e))],A);class O extends A{}a.module(v,[o.a,D.b,c.a]).service(C,A)},Oy15:function(e,t){e.exports='<span class="due-date" ng-switch on="bodyContent().localizedDueDate != null">\n  <bb-translate ng-switch-when="true" translate-values="{ datetime: \'{{bodyContent().localizedDueDate}}\' }">base.stream.entryBody.duedatedContent.dueDate</bb-translate>\n  <bb-translate ng-switch-when="false">base.stream.entryBody.duedatedContent.noDueDate</bb-translate>\n</span>\n\n'},ZNC7:function(e,t,s){"use strict";var r=s("nbDY"),n=s.n(r);class a extends n.a{constructor(e,t){super(e),this.cssClassObj=t}getCSSClass(){return this.cssClassObj.cssClass}getFirstCSSClass(){return this.cssClassObj.firstCssClass}}a.BoxNotification=new a("BOX_NOTIFICATION",{cssClass:"notification-box",firstCssClass:"first-of-box"}),a.DefaultNotification=new a("DEFAULT_NOTIFICATION",{cssClass:"notification-default"}),t.a=a},av75:function(e,t,s){"use strict";s.d(t,"a",(function(){return d}));var r=s("nbDY"),n=s.n(r),a=s("u2fd"),i=s("Oy15"),o=s("gFY1"),c=s("sbY4"),l=s("8iPc");class d extends n.a{constructor(e,t){super(e),this.templateObj=t}getTemplateHtml(){return this.templateObj.template}}d.SimpleText=new d("SIMPLE_TEXT",{template:a}),d.DueDatedContent=new d("DUE_DATED_CONTENT",{template:i}),d.Calendar=new d("CALENDAR",{template:o}),d.Grades=new d("GRADES",{template:c}),d.Telemetry=new d("TELEMETRY",{template:l})},gFY1:function(e,t){e.exports='<p class="summary">{{bodyContent().eventDescription}}</p>\n<bb-translate ng-if="!(bodyContent().isAllDayEvent)" translate-values="{ datetime: \'{{bodyContent().localizedEventDate}}\' }">base.stream.entryBody.calendar.eventDate</bb-translate>\n<bb-translate ng-if="bodyContent().isAllDayEvent" translate-values="{ date: \'{{bodyContent().localizedEventDate}}\' }">base.stream.entryBody.calendar.allDayEventDate</bb-translate>\n'},iG2q:function(e,t,s){"use strict";var r=s("nsO7"),n=s("Llzl"),a=s("nbDY"),i=s.n(a),o=s("7C3+"),c=s("m3mx"),l=s("Fvsw"),d=s("pjml"),u=s("0JpG"),h=s("g66W"),p=s("av75");const m="announcementStreamEntryTransformer";class y extends o.a{constructor(e,t,s,r){super(y.SUPPORTED_EVENT_TYPES),this.bbLocalize=e,this.context=t,this.CourseModel=s,this.remove=function(){return r.all(this.notificationIds.map(e=>s.$new(this.courseId).notifications.$new(e).$destroy().$allow([404]).$asPromise()))}}convert(e){const t=super.convert(e);return t.icon="announcement",t.isGroupable=!1,t.isImportant=!1,t.remove=this.remove,this.processDetails(t,e),t}processDetails(e,t){const s=t.itemSpecificData.notificationDetails,r="SYSTEM"===s.announcementType;r&&this.context.getBrand().$then(t=>{e.header=this.bbLocalize.translateSync({locale:null,key:"base.stream.institution",params:{brand:t.bannerText}})}),e.title=s.announcementTitle,e.body={type:p.a.SimpleText,content:{bodyText:h.b(s.contentExtract),fullText:h.c(s.announcementBody)}},r?e.body.stateRef='announcement({streamEntryId:"'+e.id+'"})':t.ui&&t.ui.streamCourse&&t.ui.streamCourse.isUltra()?(e.body.stateRef="announcement-detail("+n.toJson({courseId:s.courseId,announcementId:s.sourceId,mode:c.PanelModeEnum.VIEW,courseName:e.header})+")",e.notificationIds=s.notificationIds,e.body.content.sourceId=s.sourceId):this.setLegacyCourseUrlRefToBody(t,e)}}y.SUPPORTED_EVENT_TYPES=["AN:AN_AVAIL","AN_AVAIL"],y.$inject=[u.serviceName,l.b,d.m.serviceName,"$q"];class E extends y{}n.module(o.g).service(m,y);var b=s("zGdY");class T extends o.a{constructor(e){super(T.SUPPORTED_PROVIDERS),this.bbLocalize=e}convert(e){const t=super.convert(e);return t.icon="calendar",this.processDetails(t,e.itemSpecificData.calendarDetails),t}processDetails(e,t){switch(t.calendarId){case b.KnownCalendarIdentifier.Institution:e.header=this.bbLocalize.translateSync({locale:null,key:"base.stream.calendar.institution"});break;case b.KnownCalendarIdentifier.Personal:e.header=this.bbLocalize.translateSync({locale:null,key:"base.stream.calendar.personal"})}e.title=this._getTitle(t.title);const s=new Date(t.startDate);let r=!1;if(t.endDate){const e=new Date(t.endDate);r=0===s.getHours()&&0===s.getMinutes()&&23===e.getHours()&&59===e.getMinutes()}e.contextualDate=s;const n={eventDescription:t.description,localizedEventDate:r?this.bbLocalize.formatDateSync(s,u.ILocaleDateFormat.Short):this.bbLocalize.formatDatetimeSync(s,u.ILocaleDatetimeFormat.Short),eventStartDate:s,isAllDayEvent:r};e.body={type:p.a.Calendar,content:n};const a=t.canEdit?"event-edit":"event-view";e.body.stateRef=[a,"({",'calendarId: "',t.calendarId,'",','itemSourceType: "',t.itemSourceType,'",','itemSourceId: "',t.itemSourceId,'"',"})"].join("")}_getTitle(e){return this.bbLocalize.translateSync({locale:null,key:"base.stream.entryTitle.calendar.event",params:{entryTitle:e},noWrap:!0,noEscape:!0})}}T.SUPPORTED_PROVIDERS=["bb_calendar"],T.$inject=[u.serviceName];class f extends T{}angular.module(o.g).service("calendarStreamEntryTransformer",T);class S extends i.a{}S.Blog=new S("blog"),S.Journal=new S("journal"),S.Wiki=new S("wiki");class _ extends i.a{constructor(e,t){super(e),this.learnEntryType=e,this.resourceKey=t}}_.EntryPosted=new _("EP","entryPosted"),_.EntryEdited=new _("EE","entryEdited"),_.EntryDeleted=new _("ED","entryDeleted"),_.CommentPosted=new _("CP","commentPosted"),_.CommentDeleted=new _("CD","commentDeleted");class g extends o.d{constructor(e){super(e,g.SUPPORTED_PROVIDERS)}convert(e){const t=super.convert(e);t.isGroupable=!0,t.hasParticipated=e.se_participated,t.collabAuthorUser=e.ui.streamUser;const s=e.itemSpecificData.blogDetails,r=e.itemSpecificData.wikiDetails,n=s||r;s?(t.collabType=s.isJournal?S.Journal:S.Blog,t.collabId=s.coreIdContainer,t.collabTitle=s.blogName,s.isJournal?t.eventType="JR_".concat(t.eventType):t.eventType="BL_".concat(t.eventType)):r&&(t.collabType=S.Wiki,t.collabId=r.coreIdContainer,t.collabTitle=r.wikiName),this.processDetails(t,n),this.setLegacyCourseUrlRefToBody(e,t);const a=n.others;if(a&&a.length>0){const e=t;return t.collabAuthorUser?e.authorIds=a.concat([t.collabAuthorUser.id]):e.authorIds=a,e.groupedEntryIds=[t.id],this._setGroupedEntryTitle(e,t,e.authorIds.length),e}return this._setEntryTitle(t),t}processDetails(e,t){e.collabEventType=_.parse(t.eventType),e.collabEntryId=t.coreId,e.collabEntryTitle=t.title,e.icon=e.collabType.toString(),e.body={type:p.a.SimpleText,content:{bodyText:this._getBodyText(t)}}}_setEntryTitle(e){const t=e.collabEventType.resourceKey;t||(e.title=e.collabEntryTitle);const s=this.getTitle(e),r=["base.stream.entryTitle",e.collabType,t];e.collabAuthorUser?this.getUserDisplayName(e.collabAuthorUser).then(t=>{r.push("withName"),e.title=this.bbLocalize.translateSync({locale:null,key:r.join("."),params:{entryTitle:s,userName:t}})}):(r.push("noName"),e.title=this.bbLocalize.translateSync({locale:null,key:r.join("."),params:{entryTitle:s,userName:null}}))}getTitle(e){return this._isCommentEventType(e.collabEventType)?e.collabEntryTitle:e.collabTitle}_getBodyText(e){return this._isCommentEventType(e.eventType)?e.contentExtract:e.contentExtract?this.bbLocalize.translateSync({locale:null,key:"base.stream.entryBody.withHeader",noEscape:!0,params:{header:e.title,body:e.contentExtract}}):e.title}_isCommentEventType(e){return _.CommentPosted.isEqualTo(e)||_.CommentDeleted.isEqualTo(e)}group(e){const t=o.f;if(!t.validateEntriesForGrouping(e,g.SUPPORTED_PROVIDERS))throw new o.e({message:"Could not group stream entries"});let s=[];const r={};return e.forEach(e=>{const t=this._isCommentEventType(e.collabEventType);let n=t?e.collabEntryId:e.collabId;if(!n&&t&&S.Wiki.isEqualTo(e.collabType)&&(n=e.collabEntryTitle),n){const t=[e.collabType,e.collabEventType,n].join(g.ENTRY_GROUPING_KEY_DELIMITER);(r[t]=r[t]||[]).push(e)}else s.push(e)}),Object.keys(r).forEach(e=>{const n=r[e];if(n.length>1){const r=t.getMostRecentEntry(n),a=this.distinctAuthorIds(n),i=r.courseId,o=t.getGroupedEntryIds(n),c={id:this.generateGroupedEntryId(i,e),groupedEntryIds:o,collabType:r.collabType,collabEventType:r.collabEventType,collabId:r.collabId,collabEntryId:r.collabEntryId,collabTitle:r.collabTitle,collabEntryTitle:r.collabEntryTitle,collabAuthorUser:r.collabAuthorUser,authorIds:a,entrySpecificData:r.entrySpecificData,type:r.type,providerId:r.providerId,eventType:r.eventType,notificationCreationDate:r.notificationCreationDate,icon:r.icon,isNew:t.hasNewEntry(n),isImportant:!1,isGroupable:!0,hasParticipated:n.some(e=>e.hasParticipated),courseId:i,isOrg:r.isOrg,header:r.header,headerSubtitle:r.headerSubtitle,title:null,body:r.body};this._setGroupedEntryTitle(c,r,a.length),s.push(c)}else s=s.concat(n)}),s}_setGroupedEntryTitle(e,t,s){const n=this.getTitle(t),a=["base.stream.groupedEntries",t.collabType,t.collabEventType.resourceKey];if(t.collabAuthorUser)this.getUserDisplayName(t.collabAuthorUser).then(t=>{const i=s-1,o=i>0?"plural":"";a.push("withName",o),e.title=this.bbLocalize.translateSync({locale:null,key:r.compact(a).join("."),params:{entryTitle:n,userName:t,numUsers:i}})});else{const t=s,i=t>0?"plural":"";a.push("noName",i),e.title=this.bbLocalize.translateSync({locale:null,key:r.compact(a).join("."),params:{entryTitle:n,userName:null,numUsers:t}})}}generateGroupedEntryId(e,t){return["collabGroupEntry",e,t].join(g.ENTRY_GROUPING_KEY_DELIMITER)}distinctAuthorIds(e){return o.f.getDistinctAuthorIds(e,(function(e){const t=e;return t.collabAuthorUser&&t.collabAuthorUser.id||"unknown"}))}}g.SUPPORTED_PROVIDERS=["bb_blog","bb_Wiki"],g.ENTRY_GROUPING_KEY_DELIMITER="##",g.$inject=[u.serviceName];class I extends g{}n.module(o.g).service("collabStreamEntryTransformer",g);var D=s("vhkR"),v=s("Is+C"),C=s("4nF1"),P=s("TnpK"),R=s("tdYh"),A=s("Q/M7"),O=s("f4B+"),U=s("3Bw1"),L=s("SeO5");class N extends o.c{constructor(e,t,s,r,n,a,i,o){super({CO:[N.TYPE]},o),this.bbLocalize=e,this.CourseModel=t,this.ltiService=s,this.scormService=r,this.ultraState=n,this.$modal=a,this.$rootScope=i,this._GROUPED_ENTRY_TITLE="base.stream.groupedEntries.courseContent.title",this.SUPPORTED_GROUP_PEEK_TYPES=[d.p.ContentHandler.ExternalLink,d.p.ContentHandler.File,d.p.ContentHandler.LtiPlacement,d.p.ContentHandler.LtiLink,d.p.ContentHandler.PartnerCloud]}convert(e){const t=super.convert(e);return t.isGroupable=!0,t.icon="",t.streamCourse=e.ui.streamCourse,this.processDetails(t,e.itemSpecificData),this.setLegacyCourseUrlRefToBody(e,t),t}processDetails(e,t){const s=t.notificationDetails,r=t.contentDetails;e.title=this.bbLocalize.translateSync({locale:null,key:"base.stream.entryTitle.avail",params:{entryTitle:s.title},noWrap:!0,noEscape:!0}),e.body={type:p.a.SimpleText,content:{bodyText:e.streamCourse.isUltra()?O.a.HTML(s.contentExtract||""):s.contentExtract}};let n=null;const a=C.a.normalize(r&&r.contentHandler);switch(n=d.p.ContentHandler.parse(a),e.entrySpecificData={contentItem:{id:s.courseContentId,courseId:e.courseId,contentHandler:n,title:s.title}},n){case d.p.ContentHandler.Discussion:e.body.stateRef=o.f.getDiscussionPanelStateRef(s.courseContentId,e.courseId);break;case d.p.ContentHandler.ExternalLink:{let t=r.contentSpecificExtraData;t&&(t=R.a.test(t)?t:"http://"+t,e.body.externalRef={target:"_blank",href:t});break}case d.p.ContentHandler.LtiPlacement:case d.p.ContentHandler.LtiLink:{const t=r.contentSpecificExtraData;e.entrySpecificData.contentItem.contentDetail={},e.entrySpecificData.contentItem.contentDetail[n.toString()]={itemOrigin:t},e.body.clickHandler=()=>{this.ltiService.ltiLaunch({courseId:e.courseId,contentId:s.courseContentId,showPreLaunchPanel:!0})};break}case d.p.ContentHandler.PartnerCloud:e.body.clickHandler=()=>{this.ltiService.ltiLaunch({courseId:e.courseId,contentId:s.courseContentId,showPreLaunchPanel:!0})};break;case d.p.ContentHandler.RusticiScorm:e.body.clickHandler=()=>{this.scormService.scormLaunch({courseId:e.courseId,contentId:s.courseContentId,showPreLaunchPanel:!0})};break;case d.p.ContentHandler.File:{const t=r.contentSpecificExtraData;t&&(e.entrySpecificData.contentItem.contentDetail={},e.entrySpecificData.contentItem.contentDetail[d.p.ContentHandler.File.toString()]={file:{mimeType:t},fileAssociationMode:b.FileAssociationMode.Link});const s=r.contentSpecificFileData;s&&(e.body.externalRef={target:"_blank",href:A.c(s)});break}case d.p.ContentHandler.Folder:{e.entrySpecificData.contentItem.contentDetail={};const r=t.contentDetails&&t.contentDetails.isBbPage;e.entrySpecificData.contentItem.contentDetail[d.p.ContentHandler.Folder.toString()]={isBbPage:r,isFolder:t.contentDetails&&t.contentDetails.isFolder},r&&this.setStreamEntryClickToGoToDestination(e,s,()=>{this.ultraState.goPeekState(C.b.EDIT_STATE_SREF,{id:s.courseContentId,courseId:e.courseId})});break}case d.p.ContentHandler.Journal:e.body.stateRef=o.f.getJournalPanelStateRef(s.courseContentId,e.courseId)}e.body.externalRef||e.body.stateRef||e.body.clickHandler||this.setCourseUrlRefToBody(e)}setStreamEntryClickToGoToDestination(e,t,s){e.body.clickHandler=()=>{this.CourseModel.$new(t.courseId).contents.$find(t.courseContentId).$allow(["404","403"]).$then(t=>{if(t.$response){const r=t.$response.status;404===r?this.$modal.open({template:U,scope:null}).result.then(()=>{this.$rootScope.$emit("stream-entry-parent-item-not-found",e)}):403===r?this.$modal.open({template:L,scope:null}).result.then(()=>{this.$rootScope.$emit("stream-entry-parent-item-not-found",e)}):s()}})}}group(e){const t=o.f,s=N.TYPE;if(t.validateEntriesForGrouping(e,[s])){const r=t.getMostRecentEntry(e),n=r.courseId,a=this.generateGroupedEntryId(n),i={id:a,groupedEntryIds:t.getGroupedEntryIds(e),type:s,providerId:r.providerId,notificationCreationDate:r.notificationCreationDate,icon:"document-multiple",isNew:t.hasNewEntry(e),isImportant:!1,isGroupable:!0,courseId:n,isOrg:r.isOrg,streamCourse:r.streamCourse,header:r.header,title:this.bbLocalize.translateSync({locale:null,key:this._GROUPED_ENTRY_TITLE}),entryContents:this.getGroupedEntryContents(e)};return i.streamCourse.isUltra()&&this.areAllSupportedGroupPeekEntries(i.entryContents)?i.body={stateRef:'content-group({streamEntryId:"'+a+'"})'}:this.setCourseUrlRefToBody(i),[i]}throw new o.e({message:"Could not group stream entries"})}getGroupedEntryContents(e){let t=[];return e&&Array.isArray(e)&&e.forEach(e=>{const s=e.entryContents;s?t=t.concat(s):t.push(e)}),t}generateGroupedEntryId(e){return["courseContentGroupEntry",N.TYPE,e].join("-")}setCourseUrlRefToBody(e){e.body=e.body||{},null!==e.streamCourse&&(e.body.stateRef=o.f.getCoursePanelStateRef(e.streamCourse.id))}areAllSupportedGroupPeekEntries(e){return e.every(e=>C.a.matchesHandlers(e.entrySpecificData.contentItem.contentHandler.toString(),this.SUPPORTED_GROUP_PEEK_TYPES))}}N.TYPE="CO:CO_AVAIL",N.$inject=[u.serviceName,d.m.serviceName,D.b,v.c,P.d,"$modal","$rootScope","$q"];class w extends N{}n.module(o.g).service("courseContentStreamEntryTransformer",N);var G=s("KBr+");class x extends o.a{constructor(e,t){super(x.SUPPORTED_PROVIDERS),this.bbLocalize=e,this.CourseBatchLoader=t}convert(e){const t=super.convert(e);return t.icon="survey",this.processDetails(t,e.itemSpecificData.learnDeploymentDetails),t}processDetails(e,t){t.courseId?this.CourseBatchLoader.load(t.courseId).then(t=>{e.courseId=t.id,e.header=t.name}):e.header=this.bbLocalize.translateSync({locale:null,key:"base.stream.institution",params:{brand:t.deploymentName}}),e.title=this.bbLocalize.translateSync({locale:null,key:"base.stream.entryTitle.outcomes.bb_deployment",params:{entryTitle:t.instrumentName},noWrap:!0,noEscape:!0}),e.body={type:p.a.SimpleText,content:{bodyText:this.bbLocalize.translateSync({locale:null,key:"base.stream.entryBody.bb_deployment"})}},t.deploymentUrl&&(e.body.externalRef={target:"new",href:t.deploymentUrl})}}x.SUPPORTED_PROVIDERS=["bb_deployment"],x.$inject=[u.serviceName,G.b];class B extends x{}n.module(o.g).service("deploymentStreamEntryTransformer",x);class k extends i.a{constructor(e,t,s,r,n){super(e),this.learnEntryType=e,this.resourceKey=t,this.entryTitlePropertyName=s,this.entryTitleContainsUsersName=r,this.groupingIdPropertyName=n}isGroupable(){return null!=this.groupingIdPropertyName}getGroupingId(e){return e[this.groupingIdPropertyName]}getEntryTitle(e){return e[this.entryTitlePropertyName]}isThreadEventType(){return k.ThreadPosted.isEqualTo(this)||k.ThreadSubscribed.isEqualTo(this)||k.ThreadUnsubscribed.isEqualTo(this)}}k.ForumCreated=new k("FC","forumCreated","forumName",!1,null),k.ForumSubscribed=new k("FS","forumSubscribed","forumName",!0,"forumId"),k.ForumUnsubscribed=new k("FU","forumUnsubscribed","forumName",!0,"forumId"),k.PostRated=new k("PR","postRated","msgTitle",!0,"msgId"),k.ReplyPosted=new k("RP","replyPosted","threadTitle",!0,"threadId"),k.ThreadPosted=new k("TP","threadPosted","threadTitle",!0,null),k.ThreadSubscribed=new k("TS","threadSubscribed","threadTitle",!0,"threadId"),k.ThreadUnsubscribed=new k("TU","threadUnsubscribed","threadTitle",!0,"threadId");class M extends o.d{constructor(e){super(e,M.SUPPORTED_PROVIDERS)}convert(e){const t=e.itemSpecificData.discussionboardDetails;if(t.isIndirect)return null;const s=super.convert(e);return s.hasParticipated=e.se_participated,this.processDetails(s,t),this.setLegacyCourseUrlRefToBody(e,s),s}processDetails(e,t){const s=k.parse(t.eventType),r=s.isThreadEventType();e.icon=M.ICON,e.isGroupable=!0,e.forumId=t.coreIdContainer,e.forumName=t.forumName,e.threadId=r?t.coreId:t.threadId,e.threadTitle=r?t.title:t.threadName,e.msgEventType=s,e.msgId=t.coreId,e.msgTitle=t.title,e.body={type:p.a.SimpleText,content:{bodyText:t.contentExtract},stateRef:o.f.getDiscussionPanelStateRef(t.courseContentId,e.courseId)},this._setTitle(e)}_setTitle(e){const t=["base.stream.entryTitle.disc",e.msgEventType.resourceKey],s=e.msgEventType.entryTitleContainsUsersName,r=e.msgEventType.getEntryTitle(e);s&&e.entrySpecificData&&e.entrySpecificData.streamUser?this.getUserDisplayName(e.entrySpecificData.streamUser).then(s=>{t.push("withName"),e.title=this.bbLocalize.translateSync({locale:null,key:t.join("."),params:{userName:s,entryTitle:r}})}):(s&&t.push("noName"),e.title=this.bbLocalize.translateSync({locale:null,key:t.join("."),params:{userName:null,entryTitle:r}}))}group(e){const t=o.f;if(!t.validateEntriesForGrouping(e,M.SUPPORTED_PROVIDERS))throw new o.e({message:"Could not group stream entries"});let s=[];const r={};return e.forEach(e=>{let t=!1;if(e.msgEventType.isGroupable()){const s=e.msgEventType.getGroupingId(e);if(s){t=!0;const n=[s,e.msgEventType].join(M.ENTRY_GROUPING_KEY_DELIMITER);(r[n]=r[n]||[]).push(e)}}t||s.push(e)}),Object.keys(r).forEach(e=>{const n=e.split(M.ENTRY_GROUPING_KEY_DELIMITER),a=n[0],i=n[1],o=r[e];if(o.length>1){const e=t.getMostRecentEntry(o),r=e.courseId,n=t.getGroupedEntryIds(o),c=this.distinctAuthorIds(o),l={id:this.generateGroupedEntryId(r,i,a),forumId:e.forumId,forumName:e.forumName,threadId:e.threadId,threadTitle:e.threadTitle,entrySpecificData:e.entrySpecificData,msgId:e.msgId,msgTitle:e.msgTitle,msgEventType:e.msgEventType,groupedEntryIds:n,authorIds:c,type:e.type,providerId:e.providerId,notificationCreationDate:e.notificationCreationDate,icon:M.ICON,isNew:t.hasNewEntry(o),isImportant:!1,isGroupable:!0,hasParticipated:o.some(e=>e.hasParticipated),courseId:r,isOrg:e.isOrg,header:e.header,headerSubtitle:e.headerSubtitle,title:null,body:e.body};this._setGroupedEntryTitle(l,c.length,e.msgEventType.getEntryTitle(e)),s.push(l)}else s=s.concat(o)}),s}_setGroupedEntryTitle(e,t,s){const n=["base.stream.groupedEntries.disc",e.msgEventType.resourceKey];if(e.entrySpecificData&&e.entrySpecificData.streamUser)this.getUserDisplayName(e.entrySpecificData.streamUser).then(a=>{const i=t-1,o=i>0?"plural":"";n.push("withName",o),e.title=this.bbLocalize.translateSync({locale:null,key:r.compact(n).join("."),params:{userName:a,numUsers:i,entryTitle:s}})});else{const a=t,i=a>0?"plural":"";n.push("noName",i),e.title=this.bbLocalize.translateSync({locale:null,key:r.compact(n).join("."),params:{userName:null,numUsers:a,entryTitle:s}})}}generateGroupedEntryId(e,t,s){return["discBoardGroupEntry",e,t,s].join("-")}distinctAuthorIds(e){return o.f.getDistinctAuthorIds(e,(function(e){return e.entrySpecificData&&e.entrySpecificData.streamUser&&e.entrySpecificData.streamUser.id||"unknown"}))}}M.SUPPORTED_PROVIDERS=["bb_disc"],M.ICON="discussion",M.ENTRY_GROUPING_KEY_DELIMITER="##",M.$inject=[u.serviceName];class $ extends M{}n.module(o.g).service("discussionBoardStreamEntryTransformer",M);var V=s("Sa5G"),j=s("P2dS"),H=s("8jzW"),z=s("KtUo"),F=s("IbyE"),Y=s("+O05");class q extends o.c{constructor(e,t,s,r,n,a,i,o,c){super(q.SUPPORTED_EVENT_TYPES,c),this.bbLocalize=e,this.CourseModel=s,this.ColumnModel=r,this.scoreProviderHelper=n,this.gradeColumnCategoryService=a,this.$modal=i,this.$rootScope=o,this.serverTime=t.getServerTime(),this.remove=function(){return c.all(this.notificationIds.map(e=>s.$new(this.courseId).notifications.$new(e).$destroy().$allow([404]).$asPromise()))}}convert(e){const t=super.convert(e),s=this._getEvent(t.type),{contentDetails:r,notificationDetails:n}=e.itemSpecificData;if(t.isImportant=q.OVERDUE===s,t.isImportant){if(d.ob.NotificationRecipientType.Sender.isEqualTo(n.recipientType))return null;t.remove=this.remove}return t.isGroupable=!1,this.processDetails(t,n,r),this.setLegacyCourseUrlRefToBody(e,t),t}processDetails(e,t,s){this._setDueDateDependentProperties(e,t,s),this._setGradebookColumn(e,t)}_getEvent(e){const t=e.substr(e.indexOf(":")+1);return t.indexOf("_AVAIL")>0?"AVAIL":t}_getTitle(e,t,s,r){let n=q.DUE===e&&t&&0===z.a(t,this.serverTime)?"dueToday":e.toLowerCase();return"PE"===r&&(n=`peer.${n}`),this.bbLocalize.translateSync({locale:null,key:"base.stream.entryTitle."+n,params:{entryTitle:s},noWrap:!0,noEscape:!0})}_setDueDateDependentProperties(e,t,s){const r=t.dueDate&&new Date(t.dueDate),n=this._getEvent(e.type);e.contextualDate="AVAIL"===n?null:r,e.title=this._getTitle(n,e.contextualDate,t.title,t.sourceType),e.body={type:p.a.DueDatedContent},r&&this.bbLocalize.formatDatetime(r,o.f.DUE_DATE_FORMAT).then(t=>{e.body.content={localizedDueDate:t}}),this._setClickHandler(e,t,s)}_setClickHandler(e,t,s){const r=V.f.parse(s&&s.contentHandler);if(r&&t.courseId&&t.courseContentId){this.scoreProviderHelper.openStateRef(r,{contentId:t.courseContentId,courseId:t.courseId})&&(e.body.clickHandler=()=>{this.CourseModel.$new(t.courseId).contents.$find(t.courseContentId).$allow(["404","403"]).$then(s=>{if(s.$response){const n=s.$response.status;404===n?this.$modal.open({template:U,scope:null}).result.then(()=>{this.$rootScope.$emit("stream-entry-parent-item-not-found",e)}):403===n?this.$modal.open({template:L,scope:null}).result.then(()=>{this.$rootScope.$emit("stream-entry-parent-item-not-found",e)}):this.scoreProviderHelper.openStateRef(r,{contentId:t.courseContentId,courseId:t.courseId,isCollectExternalSubmissions:Y.a.isExternalSubmissionsAssessment(s)},H.a.GoToState)}})})}}_setGradebookColumn(e,t){if(t.secondarySourceType){const s=K.SOURCETYPE_TO_PROVIDER_MAP[t.secondarySourceType],r=t.calculationType;s&&(e.entrySpecificData={gradebookColumn:this.ColumnModel.$build({scoreProviderHandle:s,calculationType:r})})}if(!n.isUndefined(t.gradebookCategoryName)&&!n.isUndefined(t.isGradebookCategoryUserDefined)){const s=this.gradeColumnCategoryService.getIconByGradebookCategory(t.gradebookCategoryName,t.isGradebookCategoryUserDefined);s&&(e.icon=s)}}}q.SUPPORTED_EVENT_TYPES={AS:["AS:DUE","AS:OVERDUE","AS:AS_AVAIL","AS:AS_GA_AVAIL","AS:AS_AVAIL_RESEND","AS:AS_GA_AVAIL_RESEND"],GB:["GB:DUE","GB:OVERDUE"],PE:["PE:DUE","PE:OVERDUE","PE:PE_AVAIL","PE:PE_AVAIL_RESEND"],PS:["PS:DUE","PS:OVERDUE","PS:PS_AVAIL","PS:PS_AVAIL_RESEND"],SU:["SU:DUE","SU:OVERDUE","SU:SU_AVAIL"],SC:["SC:DUE","SC:OVERDUE","SC:SC_AVAIL","SC:SC_AVAIL_RESEND"],TE:["TE:DUE","TE:OVERDUE","TE:TE_AVAIL","TE:TE_AVAIL_RESEND"],UA:["UA:DUE","UA:OVERDUE","UA:UA_AVAIL","UA:UA_AVAIL_RESEND"]},q.SOURCETYPE_TO_PROVIDER_MAP={BL:F.ScoreProviderHandle.Blog,JN:F.ScoreProviderHandle.Blog,DF:F.ScoreProviderHandle.Discussion,DT:F.ScoreProviderHandle.Discussion,SC:F.ScoreProviderHandle.Scorm,UA:F.ScoreProviderHandle.UltraAssignment,WK:F.ScoreProviderHandle.Wiki},q.DUE="DUE",q.OVERDUE="OVERDUE",q.$inject=[u.serviceName,l.b,d.m.serviceName,d.C.serviceName,H.c,j.c,"$modal","$rootScope","$q"];class K extends q{}n.module(o.g).service("duedatedContentStreamEntryTransformer",q);class W extends o.a{constructor(e){super(W.SUPPORTED_PROVIDERS),this.bbLocalize=e}convert(e){const t=super.convert(e);return t.icon=o.b.DEFAULT_ICON,t.header=this.bbLocalize.translateSync({locale:null,key:"base.stream.goalsAndAssessment"}),this.processDetails(t,e.itemSpecificData.evidenceDetails),t}processDetails(e,t){e.title=this.bbLocalize.translateSync({locale:null,key:"base.stream.entryTitle.outcomes.bb-evidence-collection",params:{entryTitle:t.title},noWrap:!0,noEscape:!0}),t.sessionDate&&(e.notificationCreationDate=new Date(t.sessionDate)),t.dueDate&&(e.contextualDate=new Date(t.dueDate),e.body={type:p.a.DueDatedContent},this.bbLocalize.formatDatetime(e.contextualDate,o.f.DUE_DATE_FORMAT).then(t=>{e.body.content={localizedDueDate:t}})),t.evidenceUrl&&(e.body||(e.body={type:p.a.SimpleText}),e.body.externalRef={target:"new",href:A.c(t.evidenceUrl)})}}W.SUPPORTED_PROVIDERS=["bb-evidence-collection"],W.$inject=[u.serviceName];class J extends W{}n.module(o.g).service("evidenceCollectionStreamEntryTransformer",W);class X extends o.a{constructor(e){super(X.SUPPORTED_PROVIDERS),this.bbLocalize=e}convert(e){const t=e.itemSpecificData.gradeDetails;if(!this._isGraded(t))return null;const s=super.convert(e);return s.icon="grades",s.isImportant=!1,s.isGroupable=!1,this.processDetails(s,t),this.setStateRef(s,e.ui&&e.ui.streamCourse),s}processDetails(e,t){e.title=this._getTitle(t),e.body={type:p.a.Grades,content:{isInteractive:!0,grade:this._getGrade(t),attemptsRemaining:null,feedback:O.a.text(t.instructorFeedback.displayText),pointsPossible:t.pointsPossible,displayGrade:{grade:t.displayGradeGrade,score:t.displayGradeScore},schema:{scaleType:t.scaleType},column:{possible:t.pointsPossible,calculationType:t.calculationType}}},t.lastGradedDate&&(e.notificationCreationDate=new Date(t.lastGradedDate))}setStateRef(e,t){if(t)if(t.isClassic()){const s="/webapps/gradebook/do/student/viewGrades?course_id="+t.id+"&callback=course";e.body.stateRef=o.f.getCoursePanelStateRef(t.id,s)}else e.body.stateRef="course.grades("+n.toJson({courseId:t.id})+")"}_getGrade(e){return d.ob.GradeIconType.Completed.isEqualTo(e.gradeIcon)?this.bbLocalize.translateSync({locale:null,key:"base.stream.entryBody.grades.completedScore"}):e.grade}_getTitle(e){return this.bbLocalize.translateSync({locale:null,key:"base.stream.entryTitle.grade.posted",params:{entryTitle:e.title},noWrap:!0,noEscape:!0})}_isGraded(e){return e.grade&&"-"!==e.grade||d.ob.GradeIconType.Completed.isEqualTo(e.gradeIcon)}}X.SUPPORTED_PROVIDERS=["bb_mygrades"],X.$inject=[u.serviceName];class Q extends X{}n.module(o.g).service("gradesStreamEntryTransformer",X);const Z="/webapps/blackboard/messaging/course";class ee extends o.d{constructor(e){super(e,ee.SUPPORTED_PROVIDERS)}convert(e){const t=super.convert(e);return t.icon=ee.ICON,t.isGroupable=!0,this.processDetails(t,e.itemSpecificData.messageDetails),t}processDetails(e,t){e.conversationId=t.conversationId,e.isImportant=this.isUltraMessage(t)&&!t.canBeRepliedTo,e.body={type:p.a.SimpleText,content:{bodyText:t.contentExtract},stateRef:this.getBodyStateRef(e,t)},this.setTitle(e)}setTitle(e){e.entrySpecificData&&e.entrySpecificData.streamUser?this.getUserDisplayName(e.entrySpecificData.streamUser).then(t=>{e.title=this.bbLocalize.translateSync({locale:null,key:"base.stream.entryTitle.newMessage",params:{authorName:t}})}):e.title=this.bbLocalize.translateSync({locale:null,key:"base.stream.entryTitle.newMessage",params:{authorName:null}})}isUltraMessage(e){return!!e.conversationId}getBodyStateRef(e,t){return this.isUltraMessage(t)?'stream-message({ courseId: "'+e.courseId+'", conversationId: "'+t.conversationId+'" })':'course.outline({ courseId: "'+e.courseId+'", legacyUrl: "'+A.f(Z,"messageDetail.jsp",{nav:"messages",course_id:e.courseId,folder:"inbox",course_message_id:t.messageId})+'" })'}group(e){const t=o.f;if(!t.validateEntriesForGrouping(e,ee.SUPPORTED_PROVIDERS))throw new o.e({message:"Could not group stream entries"});let s=[];const r=[],n={};return e.forEach(e=>{if(e.conversationId){(n[e.conversationId]=n[e.conversationId]||[]).push(e)}else r.push(e)}),Object.keys(n).forEach(e=>{const r=n[e];if(r.length>1){const n=t.getMostRecentEntry(r),a=n.courseId,i=t.getGroupedEntryIds(r),o=this.distinctAuthorNames(r),c={id:this.generateGroupedEntryId(a,e),groupedEntryIds:i,type:n.type,providerId:n.providerId,notificationCreationDate:n.notificationCreationDate,icon:ee.ICON,isNew:t.hasNewEntry(r),isImportant:!1,isGroupable:!0,courseId:a,isOrg:n.isOrg,header:n.header,title:null,hasParticipated:r.some(e=>e.hasParticipated),entrySpecificData:n.entrySpecificData,conversationId:e,body:n.body};this.setGroupedEntryTitle(c,r.length,o),s.push(c)}else s=s.concat(r)}),r.length>0&&(s=s.concat(r)),s}setGroupedEntryTitle(e,t,s){e.title=this.bbLocalize.translateSync({locale:null,key:r.compact(["base.stream.groupedEntries.message.title.messageNum.plural"]).join("."),params:{numUnreadMessages:t}}),this.bbLocalize.formatItems(s,2,null,!0,null).then(t=>{e.title+=t})}generateGroupedEntryId(e,t){return["messageBoardGroupEntry",e,t].join("-")}distinctAuthorNames(e){return o.f.getDistinctAuthorIds(e,e=>{let t;return e.entrySpecificData&&e.entrySpecificData.streamUser&&(t=this.bbLocalize.formatUsernameSync(e.entrySpecificData.streamUser,u.ILocaleUsernameFormat.Short,null,{noWrap:!0,noEscape:!0})),t||"unknown"})}}ee.SUPPORTED_PROVIDERS=["bb_message"],ee.ICON="message",ee.$inject=[u.serviceName];class te extends ee{}n.module(o.g).service("messageStreamEntryTransformer",ee);class se extends o.c{constructor(e,t,s){super(se.SUPPORTED_EVENT_TYPES,s),this.bbLocalize=e,this.scoreProviderHelper=t}convert(e){const t=super.convert(e);t.isImportant=!1,t.isGroupable=!1,t.title=this._getTitle(t.notificationIds,e.itemSpecificData.notificationDetails.title);const s=e.itemSpecificData.notificationDetails,r=V.f.parse(e.itemSpecificData.contentDetails&&e.itemSpecificData.contentDetails.contentHandler);t.icon=this._getNeedsGradingIcon(r);const n=e.ui.streamCourse&&e.ui.streamCourse.isUltra();return this._setStateRef(t,s,r,n),n||this.setLegacyCourseUrlRefToBody(e,t),t}_getNeedsGradingIcon(e){let t=this.scoreProviderHelper.getNeedsGradingIconByContentHandler(e);return t||(t="grades"),t}_getTitle(e,t){const s=e.length>1?"base.stream.entryTitle.newSubmission.multipleNoCount":"base.stream.entryTitle.newSubmission.single";return this.bbLocalize.translateSync({locale:null,key:s,params:{entryTitle:t},noWrap:!0,noEscape:!0})}_setStateRef(e,t,s,r){const n=t.courseId,a=t.courseContentId;if(r&&n&&a&&s){if(("TE:TE_GT_SUBMIT"===e.type||"TE:TE_GT_SUBMIT_LATE"===e.type||"UA:UA_GA_SUBMIT"===e.type||"UA:UA_GA_SUBMIT_LATE"===e.type)&&d.ob.NotificationRecipientType.Sender.isEqualTo(t.recipientType))return;const r=this.scoreProviderHelper.getSubmissionListStateRefByContentHandler(s,{contentId:a,courseId:n});r&&(e.body={stateRef:r})}}}se.SUPPORTED_EVENT_TYPES={AS:["AS:AS_ATTEMPT","AS:AS_LATE_ATTEMPT","AS:AS_GA_ATTEMPT","AS:AS_GA_LATE_ATTEMPT"],BL:["BL:BL_ATTEMPT","BL:BL_GR_ATTEMPT"],DF:["DF:DF_ATTEMPT","DF:DF_GR_ATTEMPT"],DT:["DT:DT_ATTEMPT","DT:DT_GR_ATTEMPT"],JN:["JN:JN_ATTEMPT","JN:JN_GR_ATTEMPT"],SC:["SC:SC_SUBMIT","SC:SC_SUBMIT_LATE"],TE:["TE:TE_SUBMIT","TE:TE_SUBMIT_LATE","TE:TE_GT_SUBMIT","TE:TE_GT_SUBMIT_LATE"],UA:["UA:UA_SUBMIT","UA:UA_SUBMIT_LATE","UA:UA_GA_SUBMIT","UA:UA_GA_SUBMIT_LATE"],WK:["WK:WK_ATTEMPT","WK:WK_GR_ATTEMPT"],PS:["PS:PS_SUBMIT","PS:PS_SUBMIT_LATE"],PE:["PE:PE_SUBMIT","PE:PE_SUBMIT_LATE"]},se.$inject=[u.serviceName,H.c,"$q"];class re extends se{}n.module(o.g).service("needsGradingStreamEntryTransformer",se);var ne=s("D57K"),ae=s("aHpC");let ie=class e extends o.c{constructor(t,s,r){super(e.SUPPORTED_EVENT_TYPES,r),this.bbLocalize=t,this.scoreProviderHelper=s}convert(e){const t=super.convert(e);t.isImportant=!1,t.isGroupable=!1;const s=e.itemSpecificData.notificationDetails,r=V.f.parse(e.itemSpecificData.contentDetails&&e.itemSpecificData.contentDetails.contentHandler);t.icon=this._getNeedReconcilingIcon(r),t.title=this._getTitle(t.type,e.ui.streamCourse,s.title);const n=e.ui.streamCourse&&e.ui.streamCourse.isUltra();return this._setStateRef(t,s,r,n),n||this.setLegacyCourseUrlRefToBody(e,t),t}_getNeedReconcilingIcon(e){let t=this.scoreProviderHelper.getNeedsReconcilingIconByContentHandler(e);return t||(t="grades"),t}_getTitle(e,t,s){const r=e.substr(e.indexOf(":")+1);return this.bbLocalize.translateSync({locale:null,key:"base.stream.entryTitle.simple."+r,params:{entryTitle:s},noWrap:!0,noEscape:!0})}_setStateRef(e,t,s,r){const n=t.courseId,a=t.courseContentId;if(r&&n&&a&&s){const t=this.scoreProviderHelper.getSubmissionListStateRefByContentHandler(s,{contentId:a,courseId:n});t&&(e.body={stateRef:t})}}};ie.SUPPORTED_EVENT_TYPES={GB:["GB:GB_NEEDS_RECON"]},ie=Object(ne.__decorate)([Object(ne.__param)(0,Object(ae.b)(u.serviceName)),Object(ne.__param)(1,Object(ae.b)(H.c)),Object(ne.__param)(2,Object(ae.b)("$q"))],ie);class oe extends ie{}n.module(o.g).service("needsReconcilingtreamEntryTransformer",ie);class ce extends o.c{constructor(e,t){super(ce.SUPPORTED_EVENT_TYPES,t),this.bbLocalize=e}convert(e){const t=e.itemSpecificData.notificationDetails;if(t&&"CM"===t.sourceType)return null;const s=super.convert(e);return s.isImportant=!1,s.isGroupable=!1,s.title=this._getTitle(s.type,e.ui.streamCourse,t.title),this.setLegacyCourseUrlRefToBody(e,s),s}_getTitle(e,t,s){let r=e.substr(e.indexOf(":")+1);return"CR_AVAIL"===r&&t&&t.isOrganization&&(r="ORG_AVAIL"),this.bbLocalize.translateSync({locale:null,key:"base.stream.entryTitle.simple."+r,params:{entryTitle:s},noWrap:!0,noEscape:!0})}}ce.SUPPORTED_EVENT_TYPES={CR:["CR:CR_AVAIL"],SU:["SU:SU_SUBMIT"],QU:["QU:QU_AVAIL"],CM:["CM:CM_RCVD"]},ce.$inject=[u.serviceName,d.m.serviceName,"$q"];class le extends ce{}n.module(o.g).service("simpleLegacyStreamEntryTransformer",ce);var de=s("ZNC7"),ue=s("r6lH"),he=s("zyQz"),pe=s("EtRF"),me=s("nmzr");class ye extends o.a{constructor(e,t,s){super(ye.SUPPORTED_EVENT_TYPES),this.bbLocalize=e,this.telemetry=t,this.remove=function(){let e=this.body.content.notificationId;return null==e&&(e="_"+this.body.content.sequenceId+"_1"),s.$new(e).$destroy().$asPromise()},this.analyticsContext=function(e){return e.notificationType=this.body.content.notificationType.toString(),this.body.content.phraseVariant&&(e.phraseVariant=this.body.content.phraseVariant),e}}convert(e){const t=super.convert(e),s=he.a.parse(e.extraAttribs.notificationType);let r=e.extraAttribs.notificationId;const n=s&&s.getInitialView(),a=s?s.getPhraseVariant(e):void 0,i=s?s.getIcon().toString():pe.a.DEFAULT.toString(),c=o.f.getSequenceId(e),l=s&&s.getAction(null);return t.icon=i,t.isGroupable=!1,t.title=this._getTitle(s,e),t.isImportant="true"===e.extraAttribs.important,t.telemetryNotificationType=s&&s.toString(),(e.extraAttribs.inTroubleCount||e.extraAttribs.inTroubleAbsent||e.extraAttribs.inTroubleFailing)&&(t.studentsInTrouble={studentsInTrouble:e.extraAttribs.inTroubleCount,studentsInTroubleAbsent:e.extraAttribs.inTroubleAbsent,studentsInTroubleFailing:e.extraAttribs.inTroubleFailing}),t.notificationShapeType={shape:this._getNotificationShapeType(s)},t.body={type:this._getBodyType(l),content:{bodyText:this._getBody(s,e),sequenceId:c,notificationType:s,notificationId:r,phraseVariant:a}},t.remove=this.remove,t.analyticsContext=this.analyticsContext,null==r&&(r="_"+c+"_1"),this._setBodyStateRef(l,t,r,n),t}_getBodyType(e){return e?p.a.Telemetry:p.a.SimpleText}_getTitle(e,t){return e?this.bbLocalize.translateSync(e.getTitle(t,null)):this.bbLocalize.translateSync({locale:null,key:"base.stream.telemetry.unknownType",params:{type:t.extraAttribs.notificationType}})}_getBody(e,t){if(e){const s=e.getBody(t,null);if(s.key)return this.bbLocalize.translateSync(s)}return""}_setBodyStateRef(e,t,s,r){if(r)switch(r){case me.TelemetryViewType.DIRECT_TO_COURSE:{const s=o.f.getCoursePanelStateRef(t.courseId);this._setStateRefProps(e,t,s,!0);break}case me.TelemetryViewType.INSTRUCTOR_DYNAMIC:this.telemetry.determinePanelSref(t.courseId,s).then(s=>{this._setStateRefProps(e,t,s)});break;default:{const n=this.telemetry.createPanelSref(r,t.courseId,s);this._setStateRefProps(e,t,n);break}}}_setStateRefProps(e,t,s,r=!1){e?(t.body.content.actionText=this.bbLocalize.translateSync(e),t.body.content.actionSref=s,t.body.content.isComponentActionSref=r):t.body.stateRef=s}_getNotificationShapeType(e){let t;switch(e){case he.a.SufficientActivityData:case he.a.SufficientGradeData:case he.a.StudentsInTrouble:default:t=de.a.DefaultNotification}return t}}ye.SUPPORTED_EVENT_TYPES=["bb_tel","bb_tel:ins_grade","bb_tel:stu_activity","bb_tel:stu_grade"],ye.$inject=[u.serviceName,ue.b,d.Bb.serviceName];class Ee extends ye{}n.module(o.g).service("telemetryStreamEntryTransformer",ye),s.d(t,"b",(function(){return be})),s.d(t,"c",(function(){return Te})),s.d(t,"a",(function(){return fe}));const be="ultra.service.stream.transformer",Te="streamEntryTransformer";class fe extends i.a{constructor(e,t){super(e),this.supportedTypes=t}getSupportedTypes(){return this.supportedTypes}}fe.AssignmentsAndTests=new fe("AssignmentsAndTests",r.union(K.SUPPORTED_EVENT_TYPES.AS,K.SUPPORTED_EVENT_TYPES.TE,K.SUPPORTED_EVENT_TYPES.UA)),fe.GradesAndFeedback=new fe("GradesAndFeedback",r.union(z.b(class extends se{}.SUPPORTED_EVENT_TYPES),class extends X{}.SUPPORTED_PROVIDERS,class extends ce{}.SUPPORTED_EVENT_TYPES.GB)),fe.Discussions=new fe("Discussions",class extends M{}.SUPPORTED_PROVIDERS),fe.Messages=new fe("Messages",class extends ee{}.SUPPORTED_PROVIDERS);class Se{constructor(e,...t){this._baseDataTransformer=e,this.typeToTransformer=Object.create(null),this._dataTransformers=t||[]}get dataTransformers(){return this._dataTransformers}set dataTransformers(e){this._dataTransformers=e}get baseDataTransformer(){return this._baseDataTransformer}set baseDataTransformer(e){this._baseDataTransformer=e}getDataTransformerByType(e){return this.typeToTransformer[e]=this.typeToTransformer[e]||this._lookupDataTransformerByType(e)}_lookupDataTransformerByType(e){const t=this.dataTransformers.filter(t=>t.canHandleType(e));return t&&t[0]||this.baseDataTransformer}}Se.REGISTERED_DATA_TRANSFORMERS=[m,"calendarStreamEntryTransformer","collabStreamEntryTransformer","courseContentStreamEntryTransformer","deploymentStreamEntryTransformer","discussionBoardStreamEntryTransformer","duedatedContentStreamEntryTransformer","evidenceCollectionStreamEntryTransformer","gradesStreamEntryTransformer","messageStreamEntryTransformer","needsGradingStreamEntryTransformer","simpleLegacyStreamEntryTransformer","telemetryStreamEntryTransformer","needsReconcilingtreamEntryTransformer"],Se.$inject=[o.h].concat(Se.REGISTERED_DATA_TRANSFORMERS);class _e extends Se{}n.module(be,[o.g]).service(Te,Se)},sbY4:function(e,t){e.exports='<p class="summary js-feedback" ng-if="::interactiveBodyContent.content.feedback" ng-bind-html="::interactiveBodyContent.content.feedback"></p>\n<span ng-if="::interactiveBodyContent.content">\n  <span class="stream-grade-controls">\n\n    <button id="streamEntryBodyViewGradeButton{{::interactiveBodyContent.id}}"\n            class="button button--secondary round small"\n            ng-click="interactiveBodyContent.showTheContent()"\n            bb-click-focus="#grade-value{{::interactiveBodyContent.id}} .wrapping-input-style"\n            ng-hide="interactiveBodyContent.showContent"\n            bb-translate bb-translate-attrs="{ \'aria-label\': \'base.stream.entryBody.grades.viewGrade\' }"\n            analytics-id="base.stream.entryBody.grades.viewGrade">\n      base.stream.entryBody.grades.viewGrade\n    </button>\n    \x3c!--removing aria-hidden as it is redundant ng-show is enough as it hides the content\n    cleaning this up to prevent potential bugs--\x3e\n    <div class="js-grade stream-grade"\n         ng-show="interactiveBodyContent.showContent">\n      <bb-display-grade id="grade-value{{::interactiveBodyContent.id}}" class="grade-value"\n                        column="interactiveBodyContent.content.column" grade-detail="interactiveBodyContent.content"\n                        schema="interactiveBodyContent.content.schema" display-type="GradeColor" aria-live="assertive"></bb-display-grade>\n      <button class="anchor" id="streamEntryBodyHideGradeLink{{::interactiveBodyContent.id}}"\n         ng-click="interactiveBodyContent.hideTheContent()"\n         bb-click-focus="#streamEntryBodyViewGradeButton{{::interactiveBodyContent.id}}"\n         bb-translate\n         analytics-id="base.stream.entryBody.grades.hideGrade">\n        base.stream.entryBody.grades.hideGrade\n      </button>\n    </div>\n\n  </span>\n  <div class="row js-attemptsRemaining"\n       ng-if="::interactiveBodyContent.content.attemptsRemaining"\n       bb-translate translate-values="{ numberOfAttemptsLeft: {{::interactiveBodyContent.content.attemptsRemaining}} }">\n    base.stream.entryBody.grades.attemptsLeft.plural\n  </div>\n</span>\n'},tdYh:function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));const r=/^\w+\:{1}/},u2fd:function(e,t){e.exports='<p class="summary" ng-if="bodyContent().bodyText" ng-bind-html="bodyContent().bodyText"></p>'},xpqL:function(e,t,s){"use strict";s.d(t,"a",(function(){return y})),s.d(t,"b",(function(){return E}));var r=s("D57K"),n=s("Llzl"),a=s("nsO7"),i=s("7C3+"),o=s("0JpG"),c=s("pjml"),l=s("iG2q"),d=s("yC9S"),u=s("adx1"),h=s("MOka"),p=s("z6Q5"),m=s("aHpC");const y="ultra.service.stream.manager",E="streamEntryManager",b=["GB:GB_ATT_UPDATED","GB:GB_GRA_UPDATED","GB:GB_GRA_CLEARED"];let T=class e extends u.a{constructor(e,t,s,r,n,a,i,o,c,l){super(),this.$log=e,this.$q=t,this.$rootScope=s,this.$timeout=r,this.BatchApiService=n,this.bbLocalize=a,this.streamSettingsService=i,this.CourseModel=o,this.StreamContentModel=c,this.transformer=l,this.providers={},this.entries=[],this.deletedIds=[],this.userCache={},this.courseCache={},this.userCourseAvailabilities={},this.hasMoreData=!0,d.b.OnRootScope(this.$rootScope,"membership.update",(e,t,s,r,n,a,i,o)=>{this.userCourseAvailabilities[o]&&(this.userCourseAvailabilities[o][i.id]=t.isAvailable)})}loadBundle(){return this.bbLocalize.loadBundle("features/base/stream/base-stream")}loadAllStreamEntries(e,t){return this.$q.all([this.getEntries(t),this.loadBundle()]).then(t=>(this.hasMoreData&&this.getMoreEntries().then(t=>{e&&e(this.processStreamData(t))}),this.processStreamData(t[0])),()=>({entries:[],deletedIds:[]}))}removeStreamEntryFromServer(e){if(e&&e.isImportant&&e.remove)return e.remove();const t=this.$q.defer();return t.reject("Can only remove important notifications with remove method"),t.promise}processStreamEntries(e){return(e||[]).map(e=>e&&this.processStreamEntry(e)).filter(e=>e&&b.indexOf(e.type)<0)}processStreamEntry(e){const t=i.f.getEntryType(e);return this.transformer.getDataTransformerByType(t).convert(e)}processGroupStreamEntry(e,t){const s=this.transformer.getDataTransformerByType(t);if(s.group)try{return s.group(e)}catch(e){this.$log.log(e)}else this.$log.log("Method for grouping stream entries does not exist for data transformer used for processing entries with type of "+t);return e}processStreamData(t,s=[]){const r={entries:this.processStreamEntries(t.entries),deletedIds:t.deletedIds},n=new Set;return r.entries.filter(({courseId:e,entrySpecificData:t})=>e&&a.at(t||{},"streamUser.avatar.permanentUrl")[0]).filter(({courseId:t})=>{return(new Date).getTime()-(this.userCourseAvailabilities[t]||{_lastUpdatedAt:0})._lastUpdatedAt>e.MIN_INTERNAL_COURSE_MEMBERSHIP_FETCH_IN_MS}).forEach(({courseId:e})=>{n.add(e)}),s.push(this.BatchApiService.performBatch(()=>{n.forEach(e=>{this.CourseModel.$new(e).memberships.$fetch({limit:1e4}).$asPromise().then(t=>{const s=this.userCourseAvailabilities[e]||(this.userCourseAvailabilities[e]={});s._lastUpdatedAt=(new Date).getTime(),t.forEach(e=>{s[e.userId]=e.isAvailable})})})})),r}_reset(){this.startTime=Date.now(),this.lastCall=null,this.entries=[],this.deletedIds=[]}getEntries(e){return this._reset(),this._getRawEntries(!1,e)}getMoreEntries(){const e=this.$q.when({entries:[],deletedIds:[]});return this.hasMoreData?this.getEntries(!1):e}_shouldKeepLoading(){return Date.now()-this.startTime<this.gracePeriod&&this.hasMoreData}_collectEntries(e){return this.entries=this.entries.concat(e.sv_streamEntries),this.deletedIds=this.deletedIds.concat(e.sv_deletedIds),this.$emitEvent("STREAM_CONTENT_PULLED",{entries:this.processStreamEntries(e.sv_streamEntries),deletedIds:e.sv_deletedIds}),this._shouldKeepLoading()?this._getRawEntries(!0,!1):this.$q.when({entries:this.entries,deletedIds:this.deletedIds})}_getRawEntries(t,s){const r=this.lastCall?Math.max(0,e.GET_ENTRIES_CALL_INTERVAL-(Date.now()-this.lastCall)):0;return this.$timeout(()=>{this.lastCall=Date.now();const r=this._generatePayload(t,s);return this.StreamContentModel.$new(e.ULTRA_STREAM_ID).$fetch(r).$asPromise().then(e=>(this._processProviders(e.sv_providers),this._cacheCourses(e.sv_extras.sx_courses),this._cacheUsers(e.sv_extras.sx_users),this.gracePeriod=1e3*e.sv_autoDisplayGracePeriodSeconds,this.hasMoreData=e.sv_moreData,this._populateExtras(e.sv_streamEntries),this._collectEntries(e))).catch(t=>(this.hasMoreData=!1,this.$rootScope.$emit(e.STREAMS_LOADING_ERROR_EVENT),this.$q.reject(t)))},r)}_processProviders(e){e&&e.forEach(e=>{this.providers[e.sp_provider]={sp_provider:e.sp_provider,sp_newest:e.sp_newest,sp_oldest:e.sp_oldest,sp_refreshDate:e.sp_refreshDate}})}_cacheCourses(e){(e||[]).forEach(e=>{this.courseCache[e.id]=this.CourseModel.$build(e)})}_cacheUsers(e){e.filter(e=>null!=e.sx_user).forEach(e=>{this.userCache[e.sx_id]=e.sx_user})}_populateExtras(t){const s=Object.keys(this.userCache).length>0,r=Object.keys(this.courseCache).length>0;t.forEach(t=>{if(t.ui={},s&&(t.ui.streamUser=t.se_userId&&this.userCache[t.se_userId]||null),r){const e=i.f.getCourseId(t);t.ui.streamCourse=e&&this.courseCache[e]||null}t.itemSpecificData=a.omitBy(t.itemSpecificData,a.isNull);const n=e.DETAIL_NAMES[t.providerId];if(n){const e=t.itemSpecificData[n];a.defaults(e,a.omit(t.itemSpecificData,n))}})}_generatePayload(e,t){const s=!!n.isDefined(t)&&t;return{providers:this.providers,forOverview:!1,retrieveOnly:e,flushCache:s}}$onStreamPulled(e){return super.$onEvent("STREAM_CONTENT_PULLED",e)}};T.STREAMS_LOADING_ERROR_EVENT="streams-fetching-error",T.MIN_INTERNAL_COURSE_MEMBERSHIP_FETCH_IN_MS=3e4,T.GET_ENTRIES_CALL_INTERVAL=1e3,T.ULTRA_STREAM_ID="ultra",T.DETAIL_NAMES={"bb-announcement":"notificationDetails",bb_blog:"blogDetails",bb_calendar:"calendarDetails",bb_disc:"discussionboardDetails","bb-evidence-collection":"evidenceDetails",bb_mygrades:"gradeDetails",bb_deployment:"learnDeploymentDetails",bb_message:"messageDetails","bb-nautilus":"notificationDetails",bb_Wiki:"wikiDetails"},T=Object(r.__decorate)([Object(r.__param)(0,Object(m.b)("$log")),Object(r.__param)(1,Object(m.b)("$q")),Object(r.__param)(2,Object(m.b)("$rootScope")),Object(r.__param)(3,Object(m.b)("$timeout")),Object(r.__param)(4,Object(m.b)(p.b)),Object(r.__param)(5,Object(m.b)(o.serviceName)),Object(r.__param)(6,Object(m.b)(h.b)),Object(r.__param)(7,Object(m.b)(c.m.serviceName)),Object(r.__param)(8,Object(m.b)(c.ob.serviceName)),Object(r.__param)(9,Object(m.b)(l.c))],T);class f extends T{}n.module(y,[c.N,p.a,l.b,h.a]).service(E,T)}}]);